<!doctype html>
<html lang="en">
	<head>

		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

		<!-- google font -->
		<link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,400i,600,700" rel="stylesheet">

		<!-- leaflet -->
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
		integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
		crossorigin=""/>

		<link rel="stylesheet" type="text/css" href="style.css">

		<title>CEWG!</title>

	</head>

	<body>
		
		<div class="redbackground">
			<div class="container">
				<div class="row">
					<table style="width:100%">
						<tr>
							<td style="width:170px; padding-left: 15px"><img class="redhead2" src="images/logo_sulteng.png"></td>
							<td>
								<font class="btitle">COMMUNITY ENGAGEMENT WORKING GROUP (CEWG)</font>
								<p class= "stitle">Central Sulawesi Earthquake</p>
							</td>
							<td style="width:100px; padding-right: 15px"><img class="redhead" src="images/logo.png"></td>
						</tr>
					</table>
				</div>
			</div>
		</div>

		<div class="whitebackground">
			<div class="container">
				<div class="row">
					<!-- Block -->

					<div class="col-md-12" style="text-align: left">
						<div class="col-sm">
							<p style='margin-bottom: 20px; margin-top: 10px; color: grey'>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
						</div>
						<div class="col-sm" style="margin-bottom: 20px">
							<font class="tdtit"><h3>Key Figures</h3></font>
						</div>
					</div>

					<div class="col-md-12">
						<div class="row">
							<div class="col-md-4">
								<table  style="float:left margin">
									<tr>
										<th rowspan="3">
											<img style="height: 75px; margin-left: 15px" class="img-responsive; center" src='images/responder.png'>
											<td style="padding-left:20px; color :grey"; class="thevaluedata"; id= "kf1"></td>
										</th>
									</tr>
									<tr>
										<td >
											<font class='panelTitleBold' style="font-size: 15px; padding-left: 20px">No. of responder</font>
										</td>
									</tr>
								</table>
							</div>
							<div class="col-md-2">
								<table  style="float:left margin">
									<tr>
										<th rowspan="2"> 
											<img style="height: 75px; padding-left:15px" class="img-responsive; center" src='images/male.png'>
											<td style="padding-left:20px; color :grey"; class="thevaluedata"; id="kfa2"></td>
										</th>
									</tr>
									<tr>
										<td>
											<font class='panelTitleBold' style="font-size: 15px; padding-left: 20px">Male</font>
										</td>
									</tr>
								</table>
							</div>
							<div class="col-md-2">
								<table  style="float:left margin">
									<tr>
										<th rowspan="2"> 
											<img style="height: 75px; padding-left:15px" class="img-responsive; center" src='images/female.png'>
											<td style="padding-left:20px; color :grey"; class="thevaluedata"; id="kfa3"></td>
										</th>
									</tr>
									<tr>
										<td>
											<font class='panelTitleBold' style="font-size: 15px; padding-left: 20px">Female</font>
										</td>
									</tr>
								</table>
							</div>
							<div class="col-md-2">
								<table  style="float:left margin">
									<tr>
										<th rowspan="2"> 
											<img style="height: 75px; padding-left:15px" class="img-responsive; center" src='images/boys.png'>
											<td style="padding-left:20px; color :grey"; class="thevaluedata"; id="kfa4"></td>
										</th>
									</tr>
									<tr>
										<td>
											<font class='panelTitleBold' style="font-size: 15px; padding-left: 20px">Boy</font>
										</td>
									</tr>
								</table>
							</div>
							<div class="col-md-2">
								<table  style="float:left margin">
									<tr>
										<th rowspan="2"> 
											<img style="height: 75px; padding-left:15px" class="img-responsive; center" src='images/girl.png'>
											<td style="padding-left:20px; color :grey"; class="thevaluedata"; id="kfa5"></td>
										</th>
									</tr>
									<tr>
										<td>
											<font class='panelTitleBold' style="font-size: 15px; padding-left: 20px">Girl</font>
										</td>
									</tr>
								</table>
							</div>
						</div>
					</div>
					<div class="horizontal_line" style="margin-top: 30px"></div>
				</div>
			</div>
		</div>
		<div class="whitebackground">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<div class="row">
							<div class="col-sm">
								<font class="tdtit"><h3>Feedback</h3></font>
							</div>
							<div class="col-sm">
							</div>
							<div class="col-sm" style= "text-align: right; margin-bottom: 30px">
								<font> Select Period:</font>
							</div>
							<div class="col-sm">
								<center>
									<select class="form-control" id="periodselect" data-default ="0">
									</select>     
								</center>
							</div>
							<div class="col-md-12">
								<div class="row">
									<div class="col-md-6">
										<div class="col-md-12" id="regions_div"></div>
									</div>
									<div class="col-md-6">
										<div class="row">
											<div class="col-md-6">
					    					<div class="col-md-12">Status Report</div>
					    					<div class="col-md-12 sbmaps" id="status_report"></div>
						    			</div>
						    			<div class="col-md-6">
												<div class="col-md-12">Report Category</div>
												<div class="col-md-12 sbmap" id="category_report"></div>
											</div>
											<div class="col-md-12">
												<div class="col-md-12">Sector</div>
												<div class="col-md-12 sbmap" id="sector_report"></div>
											</div>
											<div class="col-md-12">
					    					<div class="row">
					    						<div class="col-md-12"></div>
													<div class="col-md-12">Feedback Channel</div>
													<div class="col-md-12 sbmap" id="feedbak_channel"></div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="horizontal_dotted_line" style="margin-top: 30px"></div>
							<div class="col-md-12" style="margin-top: 30px" id="sankeydiagram"></div>
							</div>
							<div class="horizontal_line" style="margin-top: 30px"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="whitebackground_footer">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<table width = '100%'>
							<tr>
								<td align='left'; valign='top'><img style="height: 60%; margin-top: 0px; padding-left: 15px"; class="img-responsive hdx" src='images/support.png'></td>
								<!-- <a target="_blank" href="https://data.humdata.org"> -->
								<td align='right'; valign='top'><img style="height: 60%; margin-top: 15px; padding-right: 15px"; class="img-responsive hdx" src='images/poweredby.png'></td>
							</tr>
						</table>
					</div>
				</div>
			</div>
		</div>

		<!-- Optional JavaScript -->
		<!-- jQuery first, then Popper.js, then Bootstrap JS -->
		<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

		<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
		integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
		crossorigin=""></script>

		<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>

		<script type="text/javascript">

			var gv_status,gv_report,gv_sector,gv_channel;

    		var geojson;
					var map = L.map('regions_div', { //map is a global variable -0.38243287652926, 120.23476123809816
					    center: [-0.66791, 119.904659],
					    zoom: 10,
					    zoomDelta: 0.5,
				        zoomSnap: 0,
					    zoomControl: false,
					    layerControl:false,
					    attributionControl: false,
					    minZoom: 10,
					    maxZoom: 14,
					});

					L.control.attribution({position: 'bottomleft'}).addTo(map);
					var CartoDB_Positron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
						attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'

					});

					CartoDB_Positron.addTo(map);

			// PieChart1 ----------------------------------------------------------------------------------------------------------------------------------------

				function draw_status(thedata,divid){
					
					var thedata = [['status', 'Total']];
	    		for(x in gv_status){
	    			thedata.push([x,gv_status[x]])
	    		}
	    		
	    		// Load google charts
					google.charts.load('current', {'packages':['corechart']});
					google.charts.setOnLoadCallback(drawChart);

					// Draw the chart and set the chart values
					function drawChart() {
					  var data = google.visualization.arrayToDataTable(thedata);

					  // Optional; add a title and set the width and height of the chart
					  var options = {
					  	legend: 'none',
			        pieSliceText: 'label',
			        pieStartAngle: 100,
			        colors: ['#DB5461', '#E1737D', '#E8929A'],
			        chartArea:{
			        	left:"15%",
			        	top:10,
			        	bottom:10,
			        	width:'70%',
			        	height:'70%'
			        },
			      };

					  // Display the chart inside the <div> element with id="piechart"
					  var chart = new google.visualization.PieChart(document.getElementById('status_report'));
					  chart.draw(data, options);
					  google.visualization.events.addListener(chart, 'select', function() {
						  var sel = chart.getSelection()[0].row;
						  redrawbasestat(data[sel+1][0]);
					  	});
						}
		    	}


		  // PieChart2 ----------------------------------------------------------------------------------------------------------------------------------------

		  		function draw_report(thedata,divid){
					
					var thedata = [['kategory_ub', 'Total']];
	    		for(x in gv_report){
	    			thedata.push([x,gv_report[x]])
	    		}
	    		// Load google charts
					google.charts.load('current', {'packages':['corechart']});
					google.charts.setOnLoadCallback(drawChart);

					// Draw the chart and set the chart values
					function drawChart() {
					  var data = google.visualization.arrayToDataTable(thedata);

					  // Optional; add a title and set the width and height of the chart
					  var options = {
					  	legend: 'none',
			        pieSliceText: 'label',
			        pieStartAngle: 100,
			        colors: ['#DB5461', '#E1737D', '#E8929A', '#EEB1B7', '#F5D0D3'],
			        chartArea:{
			        	left:"15%",
			        	top:10,
			        	bottom:10,
			        	width:'70%',
			        	height:'70%'
			        },
			      };

					  // Display the chart inside the <div> element with id="piechart"
					  var chart = new google.visualization.PieChart(document.getElementById('category_report'));
					  chart.draw(data, options);
					  google.visualization.events.addListener(chart, 'select', function() {
						  var sel = chart.getSelection()[0].row;
						  redrawbasestat(data[sel+1][0]);
					  	});
						}
		    	}

		  // BarChart1 ----------------------------------------------------------------------------------------------------------------------------------------

		  		function draw_sector(thedata,divid){
					
						var thedata = [];
		    		for(x in gv_sector){
		    			thedata.push([x,gv_sector[x]])
		    		}
		    		
		    		function sortFunction(a, b) {
					    if (a[1] === b[1]) {
					        return 0;
					    }
					    else {
					        return (a[1] > b[1]) ? -1 : 1;
					    }
						}
						thedata.sort(sortFunction);
						thedata.unshift(['sector', 'Total']);		

		    		// Load google charts
						google.charts.load('current', {packages: ['corechart', 'bar']});
						google.charts.setOnLoadCallback(drawChart);
						// Draw the chart and set the chart values
						function drawChart() {
						  var data = google.visualization.arrayToDataTable(thedata);
						  // Optional; add a title and set the width and height of the chart
						  var options = {
				      	colors:['#DB5461'],
				        
				        hAxis: {
				          title: 'Sectors',
				          minValue: 0
				        },
				        vAxis: {
				          // title: 'Sectors'
				          textStyle:{
				          	fontSize:10
				          }
				        },
				        legend: { position: "none" },
				        bars: 'horizontal',
				        annotations: {
				          alwaysOutside: true,
				          textStyle: {
				            fontSize: 12,
				            auraColor: 'none',
				            color: '#555'
				          },
				        },
				        animation:{
					        duration: 1000,
					        easing: 'out',
					        startup: true
					    	},
					    };

					  // Display the chart inside the <div> element with id="piechart"
					  var chart = new google.charts.Bar(document.getElementById('sector_report'));
        		chart.draw(data, options);
						}
		    	}

		    // BarChart2 ----------------------------------------------------------------------------------------------------------------------------------------

		    	function draw_channel(thedata,divid){
					
						var thedata = [];
		    		for(x in gv_channel){
		    			thedata.push([x,gv_channel[x]])
		    		}
		    		
		    		function sortFunction(a, b) {
					    if (a[1] === b[1]) {
					        return 0;
					    }
					    else {
					        return (a[1] > b[1]) ? -1 : 1;
					    }
						}
						thedata.sort(sortFunction);
						thedata.unshift(['saluran_umpan_balik', 'Total']);		

		    		// Load google charts
						google.charts.load('current', {packages: ['corechart', 'bar']});
						google.charts.setOnLoadCallback(drawChart);
						// Draw the chart and set the chart values
						function drawChart() {
						  var data = google.visualization.arrayToDataTable(thedata);
						  // Optional; add a title and set the width and height of the chart
						  var options = {
				      	colors:['#DB5461'],
				        
				        hAxis: {
				          title: 'Channel',
				          minValue: 0
				        },
				        vAxis: {
				          // title: 'Sectors'
				          textStyle:{
				          	fontSize:10
				          }
				        },
				        legend: { position: "none" },
				        bars: 'horizontal',
				        annotations: {
				          alwaysOutside: true,
				          textStyle: {
				            fontSize: 12,
				            auraColor: 'none',
				            color: '#555'
				          },
				        },
				        animation:{
					        duration: 1000,
					        easing: 'out',
					        startup: true
					    	},
					    };

					  // Display the chart inside the <div> element with id="piechart"
					  var chart = new google.charts.Bar(document.getElementById('feedbak_channel'));
        		chart.draw(data, options);
						}
		    	}



				//SANKEY DIAGRAM
				//---------------------------------------------------------------------------------------------------------------------------------------

				function draw_sankey(thedata,divid){
					google.charts.load('current', {'packages':['sankey']});
					google.charts.setOnLoadCallback(drawChart);

					function drawChart() {
						var data = new google.visualization.arrayToDataTable(thedata);
						var colors = ['#418FDE', '#E56A54', '#999999'];
						var colors = ['#63A3E4', '#E98573', '#ABABAB', '#86B7EA', '#EEA092', '#BEBEBE', '#A8CCF0', '#F3BBB1', '#D0D0D0'];

						// Sets chart options.
						var options = {
							sankey: {
							node: {
								colors: colors
							},
							link: {
								colorMode: 'gradient',
								colors: colors
							}
						},
						backgroundColor : 'transparent'
						};

						// Instantiates and draws our chart, passing in some options.
						var chart = new google.visualization.Sankey(document.getElementById(divid));
						chart.draw(data, options);
					}
				}

				//---------------------------------------------------------------------------------------------------------------------------------------

				function compare(a,b) {
					if (a[1] < b[1])
						return 1;
					if (a[1] > b[1])
						return -1;
					return 0;
				}

				//---------------------------------------------------------------------------------------------------------------------------------------

				function initdraw(){

					// KEY FEATURE------------------------------------

					d3.csv('https://docs.google.com/spreadsheets/d/e/2PACX-1vQNbmc1upL60S1VBzxyBLEoEblM2ilsAdDVNNC1TS2wh_o7c3V-wOzxalGwhGdnL6w0dnDquHNMoAsK/pub?output=csv',function(data){
						let numberformat = d3.format(",d");
						let i = 1;
						for(x in data[0]){
							$('#kft'+i).html(x);
							$('#kf'+i).html(numberformat(data[0][x]));
							$('#kfa'+i).html(data[0][x]);
							i+=1;
						}
						// console.log(data);
					})

					//SANKEY-----------------------------------------

					d3.csv('https://docs.google.com/spreadsheets/d/e/2PACX-1vQTI1caegEFNTboDi73tx0n23U2Bjs8IpoXJtXP-RCxNSGBo6F6Q5FsG-2QlVnQWdnTQfbGtkCF3SPj/pub?output=csv',function(data){

						data = data;

						
						var divsankey = ['sankeydiagram'];
						var divpiechart1 = ['status_report'];
						var divbarchart1 = ['barchart'];

						for(yy in divsankey){
							var log = [];
							var newlog = [];
							var newlogagain = [];
							if(divsankey[yy] == 'sankeydiagram'){
								var sankey = [['Origin','Destination','Total']];
								var kolom_yang_digunakan = ['org','sector','saluran_umpan_balik','kategory_ub'];
							}else{
								var sankey = [['Origin','Destination','Total']];
								var kolom_yang_digunakan = ['org','saluran_umpan_balik','kategory_ub'];
							}
							
							data.forEach(function(d){

								let s1 = d[kolom_yang_digunakan[0]];
								let s2 = d[kolom_yang_digunakan[1]];
								let s3 = d[kolom_yang_digunakan[2]];
								let s4 = d[kolom_yang_digunakan[3]];
								
								if(!log[s1+'-'+s2]){
									log[s1+'-'+s2] = 1;
								}else{
									log[s1+'-'+s2] +=1;
								}
								if(!log[s2+'-'+s3]){
									log[s2+'-'+s3] = 1;
								}else{
									log[s2+'-'+s3] +=1;
								}
								if(!log[s3+'-'+s4]){
									log[s3+'-'+s4] = 1;
								}else{
									log[s3+'-'+s4] +=1;
								}

							})
							
							for(x in log){
								newlog.push([x,log[x]]);
							}

							newlog.sort(compare);
							// console.log(newlog);
							newlog.forEach(function(d){
								newlogagain[d[0]]=d[1];
							})

							for(x in newlogagain){
								let str = x.split('-');
								sankey.push( [str[0],str[1],log[x]] )
							}
							// console.log(sankey);


							gv_status = [];
							//FOR STATUS
							data.forEach(function(d){
								if(!gv_status[d.status]){
									gv_status[d.status] = 1;
								}else{
									gv_status[d.status] +=1;
								}
							});

							gv_report = [];
							//FOR REPORT
							data.forEach(function(d){
								if(!gv_report[d.kategory_ub]){
									gv_report[d.kategory_ub] = 1;
								}else{
									gv_report[d.kategory_ub] +=1;
								}
							});
							

							gv_sector = [];
							//FOR SECTOR
							data.forEach(function(d){
								if(!gv_sector[d.sector]){
									gv_sector[d.sector] = 1;
								}else{
									gv_sector[d.sector] +=1;
								}
							});

							gv_channel = [];
							//FOR CHANNEL
							data.forEach(function(d){
								if(!gv_channel[d.saluran_umpan_balik]){
									gv_channel[d.saluran_umpan_balik] = 1;
								}else{
									gv_channel[d.saluran_umpan_balik] +=1;
								}
							});

							// --------------------------------------------------------
							draw_sankey(sankey,divsankey[yy]);
							draw_status();
							draw_report();
							draw_sector();
							draw_channel();	
						}

					})

				}

				initdraw();


		</script>

	</body>
</html>